[English](README.md) | **Русский**

# claude-typing-ambient

Фоновый звук механической клавиатуры, пока Claude Code работает. Воспроизводит непрерывный, реалистичный стук клавиш с момента начала обработки запроса до завершения задачи.

**Работает сразу после установки** — сэмплы клавиатуры уже в комплекте. Установи, и Claude начнёт "печатать."

## Как это работает

Когда ты отправляешь сообщение, слышишь звук механической клавиатуры. Звук играет непрерывно на протяжении всего ответа Claude — чтение файлов, размышления, редактирование кода — и плавно затихает через секунду после завершения задачи. Никаких обрывов и пауз между сэмплами.

**Возможности:**
- Работает сразу после установки — сэмплы в комплекте
- Непрерывное воспроизведение при всех действиях (Read, Edit, Bash, Grep и т.д.)
- Бесшовный шаффл — плавные переходы между сэмплами
- Умное затухание: секунда задержки предотвращает обрывы между tool calls
- Пауза при запросе разрешений, возобновление при продолжении работы
- Заменяемые звуки — записи собственной клавиатуры
- Настраиваемая громкость и режим воспроизведения

## Зависимости

| Зависимость | Обязательно | Назначение |
|-------------|-------------|------------|
| **mpv** | Да | Бесшовное аудио с IPC-управлением |
| **socat** | Рекомендуется | Пауза/возобновление без перезапуска |

### Linux

```bash
# Arch / Manjaro
sudo pacman -S mpv socat

# Ubuntu / Debian
sudo apt install mpv socat

# Fedora
sudo dnf install mpv socat
```

### macOS

```bash
brew install mpv socat
```

## Установка

### Через маркетплейс (рекомендуется)

В Claude Code выполни:

```
/plugin marketplace add howdeploy/Claude-typing-ambient
/plugin install claude-typing-ambient@howdeploy-plugins
```

Перезапусти Claude Code после установки.

### Вручную

```bash
git clone https://github.com/howdeploy/Claude-typing-ambient.git
claude --plugin-dir ./Claude-typing-ambient
```

Всё. Отправь любое сообщение Claude и услышишь печать.

## Настройка

Создай `~/.claude/claude-typing-ambient.local.md`:

```markdown
---
mode: always
volume: 40
---
```

| Параметр | Значения | По умолчанию | Описание |
|----------|----------|--------------|----------|
| `mode` | `always` / `edit-only` / `off` | `always` | Когда играть звук |
| `volume` | `0`–`200` | `130` | Громкость mpv (100 = оригинальный уровень) |

**Режимы:**
- **always** — звук при любой активности Claude
- **edit-only** — только когда Claude редактирует/пишет файлы
- **off** — отключён

Конфиг на уровне проекта (`.claude/claude-typing-ambient.local.md`) перекрывает глобальный.

## Свои звуки клавиатуры

Плагин идёт с готовыми сэмплами, но ты можешь заменить их на записи своей клавиатуры.

### Что нужно

- Запись своей печати (5–10 минут, `.ogg` или `.wav`)
- **ffmpeg** — для нарезки записи на чанки

```bash
# Установка ffmpeg (нужен только для кастомных звуков)
sudo pacman -S ffmpeg    # Arch / Manjaro
sudo apt install ffmpeg  # Ubuntu / Debian
brew install ffmpeg      # macOS
```

### Шаги

1. **Запиши** свою печать на клавиатуре — Audacity, OBS, телефон, что угодно. Сохрани как `.ogg` или `.wav`.

2. **Положи** записи в директорию `raw/`:
```bash
cp ~/my-keyboard-recording.ogg raw/
```

3. **Нарежь** на сэмплы:
```bash
bash scripts/slice-samples.sh
```
Скрипт порежет записи на чанки по 20–90 секунд, отфильтрует тишину и пересоберёт плейлист. Новые звуки заменят стандартные.

4. **Перезапусти** Claude Code.

### Советы по записи

- **Тихая комната** — фоновый шум попадёт в сэмплы
- **Печатай естественно** — не гони скорость, работай как обычно
- **5–10 минут** — больше исходного материала = меньше повторов
- **Несколько сессий** — записывай в разные дни для разнообразия

### Настройка нарезки

Отредактируй `scripts/slice-samples.sh`:

| Переменная | По умолчанию | Описание |
|------------|--------------|----------|
| `MIN_LEN` | `20.0` | Минимальная длина чанка (секунды) |
| `MAX_LEN` | `90.0` | Максимальная длина чанка (секунды) |
| `FADE_MS` | `0.3` | Кроссфейд на границах чанков (секунды) |
| `MIN_PEAK_DB` | `-30` | Отбрасывать чанки тише этого порога |

Короткие чанки (5–15 сек) дают больше разнообразия, но рискуют слышимыми стыками. Длинные (30–90 сек) звучат естественнее.

## Команды

| Команда | Описание |
|---------|----------|
| `/claude-typing-ambient:setup` | Нарезать записи на сэмплы |
| `/claude-typing-ambient:test` | Проиграть 5 секунд печати, показать конфиг |

## Архитектура

Жизненный цикл на хуках плагинной системы Claude Code.

### Поток событий

```
UserPromptSubmit  →  запуск mpv (шаффл, gapless, цикл)
       │
PreToolUse (*)    →  keepalive: отмена fade, unpause если на паузе
       │
Stop              →  fade: пауза через 1 сек задержки
       │              (отменяется следующим PreToolUse)
       │
PermissionRequest →  мгновенная пауза (нужно действие пользователя)
       │
SessionEnd        →  убить процесс mpv, очистка
```

### Почему звук непрерывный

Ключевая идея: `PreToolUse` срабатывает на **каждый** инструмент (Read, Edit, Bash, Grep, Glob...), а не только на запись. Каждый вызов инструмента отменяет отложенный fade и снимает паузу. Событие `Stop` только *планирует* паузу с задержкой — если Claude продолжает работу в течение секунды, fade отменяется и воспроизведение продолжается.

### Файлы

| Файл | Назначение |
|------|------------|
| `hooks/hooks.json` | Регистрация хуков (точка входа плагина) |
| `hooks/start-typing.sh` | Конфиг, управление процессом, запуск плеера |
| `hooks/stop-typing.sh` | Fade/пауза/стоп/kill с IPC и сигналами |
| `samples/chunks/` | Готовые аудио-сэмплы (в комплекте) |
| `samples/typing-playlist.m3u` | Шаффлированный плейлист для mpv |
| `scripts/slice-samples.sh` | Нарезка кастомных звуков через ffmpeg |
| `scripts/detect-player.sh` | Детекция аудио-плеера |
| `.claude-plugin/plugin.json` | Метаданные плагина |
| `commands/setup.md` | Слэш-команда `/setup` |
| `commands/test.md` | Слэш-команда `/test` |

### Рантайм-состояние

Директория `var/` (gitignored) хранит:
- `typing.pid` — PID активного процесса mpv
- `mpv.sock` — Unix-сокет для IPC-команд mpv
- `fade.pending` — файл-маркер отложенного fade-таймера

### Запасные плееры

Если mpv недоступен, плагин пробует: `ffplay` → `paplay` → `aplay` → `afplay`. Запасные плееры не поддерживают gapless-воспроизведение и IPC-управление.

## Решение проблем

**Нет звука:**
- Запусти `bash scripts/detect-player.sh` — найден ли mpv?
- Проверь `ls samples/chunks/ | wc -l` — есть ли сэмплы?
- Убедись, что режим не `off` в конфиге

**Звук не останавливается после завершения:**
- Запусти `bash hooks/stop-typing.sh kill` для принудительной остановки
- Проверь PID: `cat var/typing.pid`, затем `kill -0 $(cat var/typing.pid)`

**Прерывистое воспроизведение / паузы между сэмплами:**
- Убедись, что установлен `mpv` (только он поддерживает gapless)
- Проверь, что в `samples/chunks/` минимум 5 чанков
- Попробуй увеличить `MIN_LEN` в `scripts/slice-samples.sh` и перенарезать

**Звук слишком тихий или громкий:**
- Настрой `volume` в конфиге (50 = половина, 100 = норма, 150 = усиление)

## Лицензия

MIT
